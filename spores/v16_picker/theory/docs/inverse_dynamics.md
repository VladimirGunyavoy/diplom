# Обратная дискретизованная динамика маятника

## Введение

В этом документе рассматривается задача нахождения предыдущего состояния системы ($x_{n-1}$) на основе текущего состояния ($x_n$), используя дискретизованную модель динамики маятника.

## Прямая модель динамики

Стандартная дискретизованная модель динамики маятника в пространстве состояний имеет вид:

$x_{n+1} = Ax_n + Bu_n$

где:
- $x_n$ — вектор состояния в момент времени `n`.
- $u_n$ — вектор управления в момент времени `n`.
- $A$ — матрица динамики системы.
- $B$ — матрица управления.

## Вывод обратной модели

Чтобы найти $x_{n-1}$ зная $x_n$, мы можем переписать уравнение прямой динамики для шага `n-1`:

$x_n = Ax_{n-1} + Bu_{n-1}$

Наша цель — выразить $x_{n-1}$ из этого уравнения. Для этого сначала вычтем член с управлением:

$Ax_{n-1} = x_n - Bu_{n-1}$

Теперь, чтобы получить $x_{n-1}$, нам нужно умножить обе части уравнения на матрицу, обратную к $A$, то есть $A^{-1}$.

$A^{-1}Ax_{n-1} = A^{-1}(x_n - Bu_{n-1})$

Поскольку $A^{-1}A = I$ (единичная матрица), мы получаем:

$x_{n-1} = A^{-1}(x_n - Bu_{n-1})$

## Условие существования

Обратная модель существует только в том случае, если матрица $A$ обратима, то есть ее определитель не равен нулю ($\det(A) \neq 0$). Если матрица $A$ вырождена, то однозначно восстановить предыдущее состояние системы невозможно. 

## Пример: Маятник с трением

Рассмотрим линеаризованную модель математического маятника с вязким трением и управляющим моментом.

### Непрерывная модель

Дифференциальное уравнение, описывающее движение маятника вблизи нижнего положения равновесия ($\sin(\theta) \approx \theta$), имеет вид:

$L\ddot{\theta} + \gamma\dot{\theta} + g\theta = u(t)$

где:
- $\theta$ — угол отклонения маятника.
- $\dot{\theta}$ — угловая скорость.
- $\ddot{\theta}$ — угловое ускорение.
- $L$ — длина подвеса.
- $g$ — ускорение свободного падения.
- $\gamma$ — коэффициент вязкого трения.
- $u(t)$ — управляющий момент, приложенный к маятнику.

### Пространство состояний

Для представления модели в пространстве состояний выберем вектор состояния $x = [\theta, \dot{\theta}]^T$. Тогда производная вектора состояния будет:

$\dot{x} = \begin{bmatrix} \dot{\theta} \\ \ddot{\theta} \end{bmatrix} = \begin{bmatrix} \dot{\theta} \\ -\frac{g}{L}\theta - \frac{\gamma}{L}\dot{\theta} + \frac{1}{L}u(t) \end{bmatrix}$

Это можно записать в стандартной матричной форме $\dot{x} = Ax + Bu$:

$A = \begin{bmatrix} 0 & 1 \\ -\frac{g}{L} & -\frac{\gamma}{L} \end{bmatrix}, \quad B = \begin{bmatrix} 0 \\ \frac{1}{L} \end{bmatrix}$

Определитель матрицы $A$ для непрерывной модели равен:
$\det(A) = (0 \cdot (-\frac{\gamma}{L})) - (1 \cdot (-\frac{g}{L})) = \frac{g}{L}$

### Дискретизация

Для получения дискретной модели применим метод прямого Эйлера с шагом дискретизации $\Delta t$:

$x_{n+1} \approx (I + \Delta t A)x_n + (\Delta t B)u_n$

Таким образом, дискретные матрицы $A_d$ и $B_d$ будут следующими:

$A_d = I + \Delta t A = \begin{bmatrix} 1 & \Delta t \\ -\frac{g\Delta t}{L} & 1 - \frac{\gamma\Delta t}{L} \end{bmatrix}$

$B_d = \Delta t B = \begin{bmatrix} 0 \\ \frac{\Delta t}{L} \end{bmatrix}$

Определитель матрицы $A_d$ для дискретной модели равен:
$\det(A_d) = 1 \cdot (1 - \frac{\gamma\Delta t}{L}) - \Delta t \cdot (-\frac{g\Delta t}{L}) = 1 - \frac{\gamma\Delta t}{L} + \frac{g(\Delta t)^2}{L}$

### Обратная дискретная модель

Используя эти матрицы, мы можем применить ранее выведенную формулу для нахождения предыдущего состояния:

$x_{n-1} = A_d^{-1}(x_n - B_d u_{n-1})$

Для существования обратной модели необходимо, чтобы матрица $A_d$ была обратимой ($\det(A_d) \neq 0$). Как было показано выше, для типичных физических параметров и малого шага $\Delta t$ это условие выполняется, что обеспечивает возможность нахождения обратной динамики. 

### Упрощенные обозначения для обратной динамики

Для удобства дальнейших выкладок и программной реализации введем следующие обозначения.

#### Обратная матрица динамики ($A_{inv}$)

Обозначим обратную матрицу $A_d^{-1}$ как $A_{inv}$. Используя общую формулу для обращения матрицы 2x2, мы можем найти для нее явное выражение:

$A_{inv} = A_d^{-1} = \frac{1}{\det(A_d)} \begin{bmatrix} 1 - \frac{\gamma\Delta t}{L} & -\Delta t \\ \frac{g\Delta t}{L} & 1 \end{bmatrix}$

#### Обратная матрица управления ($B_{inv}$)

Преобразуем исходное уравнение обратной динамики, раскрыв скобки:

$x_{n-1} = A_{inv}(x_n - B_d u_{n-1}) = A_{inv}x_n - A_{inv}B_d u_{n-1}$

Введем новую матрицу $B_{inv} = -A_{inv}B_d$. Тогда уравнение примет финальный вид:

$x_{n-1} = A_{inv}x_n + B_{inv}u_{n-1}$

Вычислим явное выражение для $B_{inv}$:

$B_{inv} = - \left( \frac{1}{\det(A_d)} \begin{bmatrix} 1 - \frac{\gamma\Delta t}{L} & -\Delta t \\ \frac{g\Delta t}{L} & 1 \end{bmatrix} \right) \begin{bmatrix} 0 \\ \frac{\Delta t}{L} \end{bmatrix} = - \frac{1}{\det(A_d)} \begin{bmatrix} -\frac{(\Delta t)^2}{L} \\ \frac{\Delta t}{L} \end{bmatrix} = \frac{1}{\det(A_d)} \begin{bmatrix} \frac{(\Delta t)^2}{L} \\ -\frac{\Delta t}{L} \end{bmatrix}$

Эта форма записи с использованием матриц $A_{inv}$ и $B_{inv}$ является наиболее удобной для реализации, так как разделяет влияние текущего состояния $x_n$ и предыдущего управления $u_{n-1}$ на вычисление предыдущего состояния $x_{n-1}$. 

## Упрощение выражений при малом шаге $\Delta t$

В практических приложениях часто можно добиться значительного упрощения формул, если принять допущение о малости шага дискретизации $\Delta t$. Это позволяет пренебречь всеми членами, содержащими $\Delta t$ в степени 2 и выше (т.е. $O((\Delta t)^2)$).

Для этого воспользуемся разложением в ряд Тейлора для знаменателя $\frac{1}{\det(A_d)}$. Сначала аппроксимируем сам знаменатель:
$\det(A_d) = 1 - \frac{\gamma\Delta t}{L} + O((\Delta t)^2) \approx 1 - \frac{\gamma\Delta t}{L}$

Тогда его обратное значение можно аппроксимировать как:
$\frac{1}{\det(A_d)} \approx \frac{1}{1 - \frac{\gamma\Delta t}{L}} \approx 1 + \frac{\gamma\Delta t}{L}$

### Упрощенная матрица $A_{inv}$

Подставим это приближение в выражение для $A_{inv}$ и отбросим все члены порядка $O((\Delta t)^2)$:

$A_{inv} \approx (1 + \frac{\gamma\Delta t}{L}) \begin{bmatrix} 1 - \frac{\gamma\Delta t}{L} & -\Delta t \\ \frac{g\Delta t}{L} & 1 \end{bmatrix} \approx \begin{bmatrix} 1 & -\Delta t \\ \frac{g\Delta t}{L} & 1 + \frac{\gamma\Delta t}{L} \end{bmatrix}$

### Упрощенная матрица $B_{inv}$

Аналогично поступим с $B_{inv}$:

$B_{inv} \approx (1 + \frac{\gamma\Delta t}{L}) \begin{bmatrix} \frac{(\Delta t)^2}{L} \\ -\frac{\Delta t}{L} \end{bmatrix} = \begin{bmatrix} O((\Delta t)^2) \\ -\frac{\Delta t}{L} + O((\Delta t)^2) \end{bmatrix} \approx \begin{bmatrix} 0 \\ -\frac{\Delta t}{L} \end{bmatrix}$

### Итоговые упрощенные уравнения

Представим упрощенную матрицу $A_{inv}$, выделив из нее единичную матрицу $I$:

$A_{inv} \approx \begin{bmatrix} 1 & -\Delta t \\ \frac{g\Delta t}{L} & 1 + \frac{\gamma\Delta t}{L} \end{bmatrix} = \begin{bmatrix} 1 & 0 \\ 0 & 1 \end{bmatrix} + \begin{bmatrix} 0 & -\Delta t \\ \frac{g\Delta t}{L} & \frac{\gamma\Delta t}{L} \end{bmatrix}$

Вынесем $-\Delta t$ из второго слагаемого:

$\begin{bmatrix} 0 & -\Delta t \\ \frac{g\Delta t}{L} & \frac{\gamma\Delta t}{L} \end{bmatrix} = -\Delta t \begin{bmatrix} 0 & 1 \\ -\frac{g}{L} & -\frac{\gamma}{L} \end{bmatrix} = -\Delta t A$

Таким образом, мы приходим к очень изящному результату, который показывает симметрию между прямой и обратной дискретизацией первого порядка:
- Прямая модель: $A_d \approx I + \Delta t A$
- Обратная модель: $A_{inv} \approx I - \Delta t A$

Подставляя это в итоговое уравнение, получаем финальную, наиболее наглядную форму:

$x_{n-1} \approx (I - \Delta t A) x_n - (\Delta t B) u_{n-1}$

*Примечание: здесь мы также подставили упрощенное выражение $B_{inv} \approx \begin{bmatrix} 0 \\ -\frac{\Delta t}{L} \end{bmatrix} = -\Delta t B$.*

Эта форма не только проста для реализации, но и глубоко отражает связь между непрерывной и дискретной моделями системы. 