# ะะพะบัะผะตะฝัะฐัะธั: ะกะธััะตะผะฐ ะะฐะปะตะฝัะฝะพััะธ ะกะฟะพั

> **โ๏ธ ะะะะะ:** ะญัะฐ ะดะพะบัะผะตะฝัะฐัะธั ะพะฟะธััะฒะฐะตั **ะธัะฟัะฐะฒะปะตะฝะฝัั ะฒะตััะธั v2.0** (2025-10-17).
> ะกะผ. ัะฐะทะดะตะป [ะััะพัะธั ะธัะฟัะฐะฒะปะตะฝะธะน](#ะธััะพัะธั-ะธัะฟัะฐะฒะปะตะฝะธะน) ะดะปั ะดะตัะฐะปะตะน.

## ะะณะปะฐะฒะปะตะฝะธะต
1. [ะัะฐัะบะฐั ัะฒะพะดะบะฐ ะธัะฟัะฐะฒะปะตะฝะธะน](#ะบัะฐัะบะฐั-ัะฒะพะดะบะฐ-ะธัะฟัะฐะฒะปะตะฝะธะน) โญ **ะะะงะะะขะ ะะะะกะฌ**
2. [ะะฑะทะพั](#ะพะฑะทะพั)
3. [ะะพะฝัะตะฟัะธั ะฒะฐะปะตะฝัะฝะพััะธ](#ะบะพะฝัะตะฟัะธั-ะฒะฐะปะตะฝัะฝะพััะธ)
4. [ะกัััะบัััะฐ ัะปะพัะพะฒ](#ััััะบัััะฐ-ัะปะพัะพะฒ)
5. [ะคะธะทะธัะตัะบะธะน ัะผััะป](#ัะธะทะธัะตัะบะธะน-ัะผััะป)
6. [ะัะฐะฒะธะปะฐ ะฐะฝะฐะปะธะทะฐ](#ะฟัะฐะฒะธะปะฐ-ะฐะฝะฐะปะธะทะฐ)
7. [ะัะธะผะตัั](#ะฟัะธะผะตัั)
8. [ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ](#ัะตัะฝะธัะตัะบะธะต-ะดะตัะฐะปะธ)
9. [ะััะพัะธั ะธัะฟัะฐะฒะปะตะฝะธะน](#ะธััะพัะธั-ะธัะฟัะฐะฒะปะตะฝะธะน)

---

## ะัะฐัะบะฐั ัะฒะพะดะบะฐ ะธัะฟัะฐะฒะปะตะฝะธะน

### ๐ฏ ะ ัะตะผ ะฑัะปะฐ ะฟัะพะฑะปะตะผะฐ?

#### ะะปะฐะฒะฝะฐั ะฟัะพะฑะปะตะผะฐ: ะะตะฟัะฐะฒะธะปัะฝะพะต ะฟะพะฝะธะผะฐะฝะธะต ัะธะทะธะบะธ

**โ ะัะธะฑะพัะฝะพ ะดัะผะฐะปะธ:** ะัะธ ะดะฒะธะถะตะฝะธะธ ะฟัะพัะธะฒ ัะตะฑัะฐ ัะฟัะฐะฒะปะตะฝะธะต ะธะฝะฒะตััะธััะตััั (u โ -u)

**โ ะะฐ ัะฐะผะพะผ ะดะตะปะต:** ะฃะฟัะฐะฒะปะตะฝะธะต **ะะ ะผะตะฝัะตััั**, ะผะตะฝัะตััั ัะพะปัะบะพ **ะทะฝะฐะบ ะฒัะตะผะตะฝะธ** (dt โ -dt)

#### ะะฝะฐะปะพะณะธั ั ะฟะพะตะทะดะพะผ:

```
โโโโโโโโโโโโโโโโบ ะะตะปััั (ัะฟัะฐะฒะปะตะฝะธะต u=-2, ะณะพะปัะฑัะต)

ะะพะตะทะด ะตะดะตั ะฒะฟะตัะตะด:  dt=+0.049  โ forward_min
ะะพะตะทะด ะตะดะตั ะฝะฐะทะฐะด:   dt=-0.049  โ backward_min

ะะตะปััั (ัะฟัะฐะฒะปะตะฝะธะต) ะพััะฐะปะธัั ัะตะผะธ ะถะต!
ะะทะผะตะฝะธะปะพัั ัะพะปัะบะพ ะฝะฐะฟัะฐะฒะปะตะฝะธะต ะดะฒะธะถะตะฝะธั (ะฒัะตะผั)!
```

### ะัะต ะธัะฟัะฐะฒะปะตะฝะฝัะต ะฟัะพะฑะปะตะผั:

1. **โ ะัะพะฑะปะตะผะฐ:** ะฃะฟัะฐะฒะปะตะฝะธะต ะธะฝะฒะตััะธัะพะฒะฐะปะพัั ะดะปั ะฒัะพะดััะธั ัะฒัะทะตะน
   **โ ะัะฟัะฐะฒะปะตะฝะพ:** ะขะตะฟะตัั ะะ ะธะฝะฒะตััะธััะตััั (ะพััะฐะตััั ะบะฐะบ ะฒ ัะตะฑัะต)

2. **โ ะัะพะฑะปะตะผะฐ:** ะขะพะปัะบะพ 4 ะผะฐัััััะฐ ะฒะฝัะบะพะฒ ะฒะผะตััะพ 8
   **โ ะัะฟัะฐะฒะปะตะฝะพ:** ะขะตะฟะตัั 8 ะผะฐัััััะพะฒ ั ะพะฑัะทะฐัะตะปัะฝะพะน ะฐะปััะตัะฝะฐัะธะตะน ัะฟัะฐะฒะปะตะฝะธั

3. **โ ะัะพะฑะปะตะผะฐ:** ะะตะฟัะฐะฒะธะปัะฝัะน ะฟะพััะดะพะบ ัะปะพัะพะฒ ะดะตัะตะน
   **โ ะัะฟัะฐะฒะปะตะฝะพ:** forward_max, forward_min, backward_max, backward_min

4. **โ ะัะพะฑะปะตะผะฐ:** dt_value ะฑัะป None ะฟะพัะปะต ะทะฐะณััะทะบะธ ะธะท JSON
   **โ ะัะฟัะฐะฒะปะตะฝะพ:** ะงะธัะฐะตะผ ะดะฐะฝะฝัะต ะธะท EdgeInfo ะฝะฐะฟััะผัั

### ะะปััะตะฒะพะน ะฟัะธะฝัะธะฟ (ะทะฐะฟะพะผะฝะธัั!)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะฃะะะะะะะะะ ะะะะะะะะฏะะข ะขะะะะะขะะะะฎ                   โ
โ  ะะะะะฏ ะะะะะะะะฏะะข ะะะะะะะะะะะ ะะะะะะะะฏ ะะ ะะะ      โ
โ                                                     โ
โ  ะฃะฟัะฐะฒะปะตะฝะธะต ะะ ะะะะฏะะขะกะฏ ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ ะฝะฐะฟัะฐะฒะปะตะฝะธั! โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะัะปะพ โ ะกัะฐะปะพ

| ะัะฟะตะบั | ะะพ v2.0 โ | ะะพัะปะต v2.0 โ |
|--------|-----------|---------------|
| ะฃะฟัะฐะฒะปะตะฝะธะต ะดะปั IN-ัะฒัะทะตะน | ะะฝะฒะตััะธัะพะฒะฐะปะพัั | ะะ ะธะฝะฒะตััะธััะตััั |
| ะะฐัััััั ะฒะฝัะบะพะฒ | 4 | 8 (ั ะฐะปััะตัะฝะฐัะธะตะน) |
| ะะพััะดะพะบ ะดะตัะตะน | ะะตะฟัะฐะฒะธะปัะฝัะน | ะัะฐะฒะธะปัะฝัะน |
| ะะฐะณััะทะบะฐ ะธะท JSON | dt=None | ะะฐะฑะพัะฐะตั |

---

## ะะฑะทะพั

**ะะฐะปะตะฝัะฝะพััั ัะฟะพัั** โ ััะพ ัะธััะตะผะฐ ะพััะปะตะถะธะฒะฐะฝะธั ะฒัะตั ะฒะพะทะผะพะถะฝัั ะฒะฐะปะตะฝัะฝัั (ัะฒัะทะตะฒัั) ะผะตัั ัะฟะพัั ั ะตั ัะพัะตะดัะผะธ ะฟะตัะฒะพะณะพ ะธ ะฒัะพัะพะณะพ ะฟะพััะดะบะฐ.

ะะฐะถะดะฐั ัะฟะพัะฐ ะธะผะตะตั **12 ะฒะฐะปะตะฝัะฝัั ัะปะพัะพะฒ**:
- **4 ัะปะพัะฐ ะดะปั ะดะตัะตะน** (ัะพัะตะดะธ 1-ะณะพ ะฟะพััะดะบะฐ)
- **8 ัะปะพัะพะฒ ะดะปั ะฒะฝัะบะพะฒ** (ัะพัะตะดะธ 2-ะณะพ ะฟะพััะดะบะฐ, ัะพะปัะบะพ ั ะฐะปััะตัะฝะฐัะธะตะน ัะฟัะฐะฒะปะตะฝะธั)

### ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั:

```
spores/v16_picker/src/
โโโ logic/
โ   โโโ valence.py              # ะะปะฐััั ValenceSlot ะธ SporeValence
โโโ managers/
    โโโ valence_manager.py      # ValenceManager ะดะปั ะฐะฝะฐะปะธะทะฐ ะณัะฐัะฐ
```

---

## ะะพะฝัะตะฟัะธั ะฒะฐะปะตะฝัะฝะพััะธ

### ะงัะพ ัะฐะบะพะต ะฒะฐะปะตะฝัะฝัะน ัะปะพั?

ะะฐะปะตะฝัะฝัะน ัะปะพั โ ััะพ ะฒะพะทะผะพะถะฝะพะต ะฝะฐะฟัะฐะฒะปะตะฝะธะต ัะพััะฐ ะดะตัะตะฒะฐ ะพั ัะฟะพัั, ะพะฟัะตะดะตะปัะตะผะพะต ะดะฒัะผั ะฟะฐัะฐะผะตััะฐะผะธ:
1. **ะะฐะฟัะฐะฒะปะตะฝะธะต ะฒัะตะผะตะฝะธ** (forward/backward)
2. **ะขะธะฟ ัะฟัะฐะฒะปะตะฝะธั** (max/min)

### ะะพัะตะผั ะธะผะตะฝะฝะพ 12 ัะปะพัะพะฒ?

**4 ัะปะพัะฐ ะดะปั ะดะตัะตะน:**
```
forward_max       (dt > 0, control = +u_max)
forward_min       (dt > 0, control = -u_max)
backward_max      (dt < 0, control = +u_max)
backward_min      (dt < 0, control = -u_max)
```

**8 ัะปะพัะพะฒ ะดะปั ะฒะฝัะบะพะฒ** (ัะพะปัะบะพ ั ัะตัะตะดะพะฒะฐะฝะธะตะผ ัะฟัะฐะฒะปะตะฝะธั):
```
forward_max_forward_min       (max โ min, ะพะฑะฐ forward)
forward_max_backward_min      (max โ min, forward โ backward)
forward_min_forward_max       (min โ max, ะพะฑะฐ forward)
forward_min_backward_max      (min โ max, forward โ backward)
backward_max_forward_min      (max โ min, ะพะฑะฐ backward)
backward_max_backward_min     (max โ min, backward โ forward)
backward_min_forward_max      (min โ max, ะพะฑะฐ backward)
backward_min_backward_max     (min โ max, backward โ forward)
```

**โ๏ธ ะะะะะ:** ะะปั ะฒะฝัะบะพะฒ ััะธััะฒะฐัััั **ะขะะะฌะะ** ะฟััะธ ั **ัะตัะตะดะพะฒะฐะฝะธะตะผ ัะฟัะฐะฒะปะตะฝะธั** (maxโmin ะธะปะธ minโmax).

ะััะธ ะฑะตะท ัะตัะตะดะพะฒะฐะฝะธั **ะธัะบะปััะตะฝั**:
```
โ forward_max โ forward_max   (maxโmax)
โ forward_min โ forward_min   (minโmin)
โ backward_max โ backward_max (maxโmax)
โ backward_min โ backward_min (minโmin)
```

---

## ะกัััะบัััะฐ ัะปะพัะพะฒ

### ValenceSlot

```python
@dataclass
class ValenceSlot:
    slot_type: str              # 'child' ะธะปะธ 'grandchild'
    time_direction: str         # 'forward' ะธะปะธ 'backward'
    control_type: str           # 'max' ะธะปะธ 'min'
    second_time_direction: Optional[str] = None  # ะขะพะปัะบะพ ะดะปั ะฒะฝัะบะพะฒ

    # ะะฐะฝะฝัะต ะพ ะทะฐะฝััะพััะธ
    dt_value: Optional[float] = None       # ะกัะผะผะฐัะฝะพะต ะฒัะตะผั
    dt_sequence: Optional[List[float]]     # ะะปั ะฒะฝัะบะพะฒ: [dt1, dt2]
    occupied: bool = False                 # ะะฐะฝัั ะปะธ ัะปะพั
    neighbor_id: Optional[int] = None      # ID ัะพัะตะดะฐ
    is_fixed: bool = False                 # ะะปั ะพะฟัะธะผะธะทะฐัะพัะฐ
```

### SporeValence

```python
@dataclass
class SporeValence:
    spore_id: int
    total_slots: int = 12
    children_slots: List[ValenceSlot]      # 4 ัะปะพัะฐ
    grandchildren_slots: List[ValenceSlot] # 8 ัะปะพัะพะฒ
```

---

## ะคะธะทะธัะตัะบะธะน ัะผััะป

### ะะปััะตะฒะพะน ะฟัะธะฝัะธะฟ: ะฃะฟัะฐะฒะปะตะฝะธะต ะฝะตะธะทะผะตะฝะฝะพ ะฒะดะพะปั ััะฐะตะบัะพัะธะธ

๐ **ะกะฐะผะพะต ะฒะฐะถะฝะพะต ะดะปั ะฟะพะฝะธะผะฐะฝะธั:**

**ะฃะฟัะฐะฒะปะตะฝะธะต ัััะตะปะบะธ ะะ ะะะะฏะะขะกะฏ** ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ ะฝะฐะฟัะฐะฒะปะตะฝะธั ะดะฒะธะถะตะฝะธั!

#### ะัะธะผะตั:

ะััั ะณะพะปัะฑะฐั ัััะตะปะบะฐ (ัะฟัะฐะฒะปะตะฝะธะต u = -2) ะพั ัะฟะพัั 6 ะบ ัะฟะพัะต 2:

```
     6 โ[ะณะพะปัะฑะฐั, u=-2]โ 2
```

**ะะท ัะฟะพัั 6 ะฒ ัะฟะพัั 2:**
- ะฃะฟัะฐะฒะปะตะฝะธะต: u = -2 (min)
- ะัะตะผั: dt = +0.049 (forward, ะฟะพะปะพะถะธัะตะปัะฝะพะต)
- ะกะปะพั: **forward_min**

**ะะท ัะฟะพัั 2 ะฒ ัะฟะพัั 6:**
- ะฃะฟัะฐะฒะปะตะฝะธะต: u = -2 (min) โ **ะขะ ะะ ะกะะะะ!**
- ะัะตะผั: dt = -0.049 (backward, ะพััะธัะฐัะตะปัะฝะพะต)
- ะกะปะพั: **backward_min**

### ะะพัะตะผั ัะฟัะฐะฒะปะตะฝะธะต ะฝะต ะผะตะฝัะตััั?

ะคะธะทะธัะตัะบะธ ะผั ะดะฒะธะถะตะผัั **ะฟะพ ัะพะน ะถะต ััะฐะตะบัะพัะธะธ** ะฒ ัะฐะทะพะฒะพะผ ะฟัะพัััะฐะฝััะฒะต, ัะพะปัะบะพ ะฒ **ะฟัะพัะธะฒะพะฟะพะปะพะถะฝะพะผ ะฝะฐะฟัะฐะฒะปะตะฝะธะธ ะฟะพ ะฒัะตะผะตะฝะธ**. ะฃะฟัะฐะฒะปะตะฝะธะต ะพะฟัะตะดะตะปัะตั **ะณะตะพะผะตััะธั ััะฐะตะบัะพัะธะธ**, ะฐ ะฝะต ะฝะฐะฟัะฐะฒะปะตะฝะธะต ะดะฒะธะถะตะฝะธั ะฟะพ ะฝะตะน.

### ะะธะทัะฐะปะธะทะฐัะธั

```
ะกะฟะพัะฐ 2 (ะบะพัะตะฝั ะดะตัะตะฒะฐ):

  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ         ะกะฟะพัะฐ 2             โ
  โ    4 ะดะตัะตะน + 4 ะฒะฝัะบะฐ       โ
  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ โ     โ โ

ะะะขะ (4 ัะปะพัะฐ):
  โ forward_max โ ัะฟะพัะฐ 3  (ะบัะฐัะฝะฐั ัััะตะปะบะฐ, dt=+0.050)
  โ forward_min โ ัะฟะพัะฐ 5  (ะณะพะปัะฑะฐั ัััะตะปะบะฐ, dt=+0.049)
  โ backward_max โ ัะฟะพัะฐ 4 (ะบัะฐัะฝะฐั ัััะตะปะบะฐ, dt=-0.050)
  โ backward_min โ ัะฟะพัะฐ 6 (ะณะพะปัะฑะฐั ัััะตะปะบะฐ, dt=-0.049)

ะะะฃะะ (8 ัะปะพัะพะฒ, ัะพะปัะบะพ ะฐะปััะตัะฝะฐัะธั):
  โ forward_max_forward_min โ ัะฟะพัะฐ 7
  โ forward_max_backward_min (ัะฒะพะฑะพะดะฝะพ)
  โ forward_min_forward_max โ ัะฟะพัะฐ 7
  โ forward_min_backward_max (ัะฒะพะฑะพะดะฝะพ)
  โ backward_max_forward_min (ัะฒะพะฑะพะดะฝะพ)
  โ backward_max_backward_min โ ัะฟะพัะฐ 10
  โ backward_min_forward_max (ัะฒะพะฑะพะดะฝะพ)
  โ backward_min_backward_max โ ัะฟะพัะฐ 10
```

---

## ะัะฐะฒะธะปะฐ ะฐะฝะฐะปะธะทะฐ

### 1. ะะฝะฐะปะธะท ะธััะพะดััะธั ัะฒัะทะตะน (ะดะตัะตะน)

**ะัะฐะฒะธะปะพ:** ะะปั ะธััะพะดััะธั ัะฒัะทะตะน ะฒัะตะณะดะฐ `forward`

```python
# ะะท ัะฟะพัะฐ_id -> ะฒ child_id
time_direction = 'forward'
dt = abs(link.dt_value)      # ะัะตะณะดะฐ ะฟะพะปะพะถะธัะตะปัะฝะพะต
control = link.control_value  # ะะตัะตะผ ะบะฐะบ ะตััั ะธะท ัะตะฑัะฐ
```

**ะัะธะผะตั:**
```
ะะตะฑัะพ: ะกะฟะพัะฐ 2 โ ะกะฟะพัะฐ 3
link.control_value = +2.0 (max)
link.dt_value = 0.05

ะะตะทัะปััะฐั:
โ forward_max: dt=+0.05, ะบ ัะฟะพัะต 3
```

### 2. ะะฝะฐะปะธะท ะฒัะพะดััะธั ัะฒัะทะตะน (ัะพะดะธัะตะปะตะน)

**ะัะฐะฒะธะปะพ:** ะะปั ะฒัะพะดััะธั ัะฒัะทะตะน ะฒัะตะณะดะฐ `backward`

```python
# ะะท parent_id -> ะฒ spore_id (ัะตะฑัะพ)
# ะั ะธะดะตะผ: ะธะท spore_id -> ะฒ parent_id (ะฟัะพัะธะฒ ัะตะฑัะฐ)

time_direction = 'backward'
dt = -abs(link.dt_value)     # ะัะตะณะดะฐ ะพััะธัะฐัะตะปัะฝะพะต
control = link.control_value  # โ๏ธ ะะ ะะะะะะขะะะฃะะ! ะะตัะตะผ ะบะฐะบ ะตััั
```

**ะัะธะผะตั:**
```
ะะตะฑัะพ: ะกะฟะพัะฐ 6 โ ะกะฟะพัะฐ 2
link.control_value = -2.0 (min)
link.dt_value = 0.049

ะะท ัะฟะพัั 2 ะฒ ัะฟะพัั 6 (ะฟัะพัะธะฒ ัะตะฑัะฐ):
โ backward_min: dt=-0.049, ะบ ัะฟะพัะต 6
   control = -2.0 (ะพััะฐะปัั min!)
```

### 3. ะะฝะฐะปะธะท ะฒะฝัะบะพะฒ (2-ะน ะฟะพััะดะพะบ)

**ะะฑัะทะฐัะตะปัะฝะพะต ััะปะพะฒะธะต:** ะฃะฟัะฐะฒะปะตะฝะธะต ะะะะะะ ัะตัะตะดะพะฒะฐัััั!

```python
if first_control_type == second_control_type:
    continue  # ะัะพะฟััะบะฐะตะผ ะผะฐััััั ะฑะตะท ะฐะปััะตัะฝะฐัะธะธ
```

**ะะปะณะพัะธัะผ:**

1. ะะพะปััะฐะตะผ ะฒัะตั ะฟััะผัั ัะพัะตะดะตะน (ะดะตัะตะน) ัะตะบััะตะน ัะฟะพัั
2. ะะปั ะบะฐะถะดะพะณะพ ะฟัะพะผะตะถััะพัะฝะพะณะพ ัะพัะตะดะฐ ะฟะพะปััะฐะตะผ ะตะณะพ ัะพัะตะดะตะน
3. ะัะพะฒะตััะตะผ ัะตัะตะดะพะฒะฐะฝะธะต ัะฟัะฐะฒะปะตะฝะธั:
   ```python
   if first_control_type != second_control_type:
       # ะญัะพ ะฒะฐะปะธะดะฝัะน ะผะฐััััั ั ะฐะปััะตัะฝะฐัะธะตะน
   ```
4. ะกะพะทะดะฐะตะผ ัะปะพั ะฒะฝัะบะฐ

**ะัะธะผะตั:**
```
ะกะฟะพัะฐ 2 โ [forward_max] โ ะกะฟะพัะฐ 3 โ [forward_min] โ ะกะฟะพัะฐ 7
         u=+2, dt=+0.05            u=-2, dt=+0.048

ะัะพะฒะตัะบะฐ:
  first_control: max
  second_control: min
  max != min โ โ ะญัะพ ะฒะฐะปะธะดะฝัะน ะผะฐััััั!

ะกะปะพั: forward_max_forward_min
  dt_sequence = [+0.05, +0.048]
  total_dt = +0.098
  neighbor = ัะฟะพัะฐ 7
```

---

## ะัะธะผะตัั

### ะัะธะผะตั 1: ะัะพััะฐั ัะฟะพัะฐ ั 4 ะดะตััะผะธ

```json
{
  "spore_id": "2",
  "position": [-0.198, 1.682],
  "out_links": [
    {"to": "3", "control": 2.0,  "dt": 0.050},  // forward_max
    {"to": "5", "control": -2.0, "dt": 0.049}   // forward_min
  ],
  "in_links": [
    {"from": "4", "control": 2.0,  "dt": 0.050}, // backward_max
    {"from": "6", "control": -2.0, "dt": 0.049}  // backward_min
  ]
}
```

**ะะฐะปะตะฝัะฝะพััั:**
```
๐ ะะะะะะขะะะกะขะฌ ะกะะะะซ 2:
   ะัะตะณะพ ัะปะพัะพะฒ: 12
   ะะฐะฝััะพ: 8
   ะกะฒะพะฑะพะดะฝะพ: 4

   ๐ถ ะะะขะ (4 ัะปะพัะพะฒ, ะทะฐะฝััะพ 4, ัะฒะพะฑะพะดะฝะพ 0):
      ๐๐ง forward_max: dt=+0.050000 โ3
      ๐๐ง forward_min: dt=+0.049000 โ5
      ๐๐ง backward_max: dt=-0.050000 โ4
      ๐๐ง backward_min: dt=-0.049000 โ6

   ๐ถ๐ถ ะะะฃะะ (8 ัะปะพัะพะฒ, ะทะฐะฝััะพ 4, ัะฒะพะฑะพะดะฝะพ 4):
      ๐๐ง forward_max_forward_min: dt=+0.098000 โ7
      ๐ forward_max_backward_min: dt=None
      ๐๐ง forward_min_forward_max: dt=+0.099000 โ7
      ๐ forward_min_backward_max: dt=None
      ๐ backward_max_forward_min: dt=None
      ๐๐ง backward_max_backward_min: dt=-0.099000 โ10
      ๐ backward_min_forward_max: dt=None
      ๐๐ง backward_min_backward_max: dt=-0.100000 โ10
```

### ะัะธะผะตั 2: ะะพัะตะผั ัะฟัะฐะฒะปะตะฝะธะต ะฝะต ะธะฝะฒะตััะธััะตััั

**ะกะธััะฐัะธั:** ะัะฐัะฝะฐั ัััะตะปะบะฐ ะพั ัะฟะพัั 4 ะบ ัะฟะพัะต 2

```
ะะตะฑัะพ: 4 โ[red, u=+2]โ 2
       link.control_value = +2.0
       link.dt_value = 0.05
```

**ะะฝะฐะปะธะท ะธะท ัะฟะพัั 2:**

โ **ะะะะะะะะะฌะะ** (ััะฐัะฐั ะปะพะณะธะบะฐ):
```python
# ะัะพะดััะฐั ัะฒัะทั โ ะธะฝะฒะตััะธััะตะผ control
control = -link.control_value  # -2.0 (min)
โ backward_min  # ะะะะะะะะะฌะะ!
```

โ **ะะะะะะะฌะะ** (ัะตะบััะฐั ะปะพะณะธะบะฐ):
```python
# ะัะพะดััะฐั ัะฒัะทั โ ะะ ะธะฝะฒะตััะธััะตะผ control!
control = link.control_value  # +2.0 (max)
dt = -abs(link.dt_value)      # -0.05 (backward)
โ backward_max  # ะะะะะะะฌะะ!
```

**ะะฑัััะฝะตะฝะธะต:**

ะัะฐัะฝะฐั ัััะตะปะบะฐ ะพะทะฝะฐัะฐะตั ัะฟัะฐะฒะปะตะฝะธะต u=+2 (max). ะญัะพ ัะฟัะฐะฒะปะตะฝะธะต **ะพะฟัะตะดะตะปัะตั ััะฐะตะบัะพัะธั** ะธ **ะฝะต ะทะฐะฒะธัะธั ะพั ะฝะฐะฟัะฐะฒะปะตะฝะธั ะดะฒะธะถะตะฝะธั** ะฟะพ ะฝะตะน:

- ะะท 4 ะฒ 2: u=+2, dt=+0.05 โ ะดะฒะธะถะตะผัั ะฒะฟะตัะตะด ะฟะพ ะฒัะตะผะตะฝะธ ั ัะฟัะฐะฒะปะตะฝะธะตะผ max
- ะะท 2 ะฒ 4: u=+2, dt=-0.05 โ ะดะฒะธะถะตะผัั ะฝะฐะทะฐะด ะฟะพ ะฒัะตะผะตะฝะธ ั **ัะตะผ ะถะต** ัะฟัะฐะฒะปะตะฝะธะตะผ max

---

## ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

### ะะปะฐัั ValenceManager

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั:**

```python
class ValenceManager:
    def analyze_spore_valence(spore_id: str) -> SporeValence:
        """ะะฝะฐะปะธะทะธััะตั ะฒะฐะปะตะฝัะฝะพััั ัะฟะพัั"""

    def _get_direct_neighbors(spore_id: str) -> List[Dict]:
        """ะะพะปััะฐะตั ัะพัะตะดะตะน 1-ะณะพ ะฟะพััะดะบะฐ"""

    def _get_neighbors_at_distance_2(spore_id: str) -> List[Dict]:
        """ะะพะปััะฐะตั ัะพัะตะดะตะน 2-ะณะพ ะฟะพััะดะบะฐ (ั ะฐะปััะตัะฝะฐัะธะตะน)"""

    def print_valence_report(spore_id: str):
        """ะัะฒะพะดะธั ะฟะพะดัะพะฑะฝัะน ะพััะตั"""
```

### ะคะพัะผะฐั ะดะฐะฝะฝัั ัะพัะตะดะฐ

```python
neighbor_info = {
    'target_spore': <Spore object>,
    'target_id': '3',
    'path': ['2', '3'],
    'time_direction': 'forward',  # ะธะปะธ 'backward'
    'dt': 0.05,                   # ะะฝะฐะบ ัะพะพัะฒะตัััะฒัะตั direction
    'dt_sequence': [0.05],        # ะะปั ะฒะฝัะบะพะฒ: [dt1, dt2]
    'control': 2.0,               # ะะพะปะพะถะธัะตะปัะฝะพะต ะดะปั max, ะพััะธัะฐัะตะปัะฝะพะต ะดะปั min
    'raw_direction': 'outgoing',  # ะธะปะธ 'incoming'
}
```

### ะะฝัะตะณัะฐัะธั ั ะพะฟัะธะผะธะทะฐัะพัะพะผ

```python
valence = manager.analyze_spore_valence(spore_id)

# ะะพะปััะธัั ะทะฐัะธะบัะธัะพะฒะฐะฝะฝัะต dt (ะฝะต ััะพะณะฐัั ะฟัะธ ะพะฟัะธะผะธะทะฐัะธะธ)
fixed_dt = valence.get_fixed_dt_values()
# {'forward_max': 0.05, 'backward_min': -0.049, ...}

# ะะพะปััะธัั ัะฒะพะฑะพะดะฝัะต ัะปะพัั (ะฝัะถะฝะพ ะทะฐะฟะพะปะฝะธัั)
free_slots = valence.get_free_slot_names()
# ['forward_max_backward_min', 'forward_min_backward_max', ...]
```

---

## ะะธะฐะณัะฐะผะผะฐ ะบะปะฐััะพะฒ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           ValenceManager                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ + analyze_spore_valence(spore_id)          โ
โ + print_valence_report(spore_id)           โ
โ - _get_direct_neighbors(spore_id)          โ
โ - _get_neighbors_at_distance_2(spore_id)   โ
โ - _occupy_slot_from_neighbor(...)          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ creates
                    โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ     SporeValence          โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
        โ + spore_id                โ
        โ + children_slots (4)      โ
        โ + grandchildren_slots (8) โ
        โ + total_slots = 12        โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
        โ + get_free_slots()        โ
        โ + get_occupied_slots()    โ
        โ + find_slot_by_name()     โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ contains
                    โผ
            โโโโโโโโโโโโโโโโโโโโโโโโ
            โ   ValenceSlot        โ
            โโโโโโโโโโโโโโโโโโโโโโโโค
            โ + slot_type          โ
            โ + time_direction     โ
            โ + control_type       โ
            โ + second_time_dir    โ
            โ + dt_value           โ
            โ + occupied           โ
            โ + neighbor_id        โ
            โโโโโโโโโโโโโโโโโโโโโโโโค
            โ + get_slot_name()    โ
            โโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะงะฐัััะต ะพัะธะฑะบะธ

### โ ะัะธะฑะบะฐ 1: ะะฝะฒะตััะธัะพะฒะฐะฝะธะต ัะฟัะฐะฒะปะตะฝะธั ะดะปั ะฒัะพะดััะธั ัะฒัะทะตะน

```python
# ะะะะะะะะะฌะะ
control_value = -raw_control  # ะะฝะฒะตััะธััะตะผ ัะฟัะฐะฒะปะตะฝะธะต
```

**ะะพัะตะผั ะฝะตะฟัะฐะฒะธะปัะฝะพ:** ะฃะฟัะฐะฒะปะตะฝะธะต ะพะฟัะตะดะตะปัะตััั **ััะฐะตะบัะพัะธะตะน**, ะฐ ะฝะต ะฝะฐะฟัะฐะฒะปะตะฝะธะตะผ ะดะฒะธะถะตะฝะธั ะฟะพ ะฝะตะน.

### โ ะัะธะฑะบะฐ 2: ะะฐะฑััั ะฟัะพ ะฐะปััะตัะฝะฐัะธั ะดะปั ะฒะฝัะบะพะฒ

```python
# ะะะะะะะะะฌะะ - ะฒะบะปััะฐะตะผ ะฒัะต ะผะฐัััััั
for first in children:
    for second in grandchildren:
        add_slot(first, second)  # ะัะดะตั 16 ัะปะพัะพะฒ ะฒะผะตััะพ 8!
```

**ะัะฐะฒะธะปัะฝะพ:**

```python
# ะะะะะะะฌะะ - ัะพะปัะบะพ ั ะฐะปััะตัะฝะฐัะธะตะน
if first_control_type != second_control_type:
    add_slot(first, second)  # ะขะพะปัะบะพ 8 ัะปะพัะพะฒ
```

### โ ะัะธะฑะบะฐ 3: ะะตะฟัะฐะฒะธะปัะฝัะน ะทะฝะฐะบ dt

```python
# ะะะะะะะะะฌะะ ะดะปั ะฒัะพะดััะธั
dt_value = abs(raw_dt)  # ะะพะปะพะถะธัะตะปัะฝะพะต ะดะปั backward!
```

**ะัะฐะฒะธะปัะฝะพ:**

```python
# ะะปั outgoing: ะฒัะตะณะดะฐ ะฟะพะปะพะถะธัะตะปัะฝะพะต
dt_value = abs(raw_dt)

# ะะปั incoming: ะฒัะตะณะดะฐ ะพััะธัะฐัะตะปัะฝะพะต
dt_value = -abs(raw_dt)
```

---

## ะขะตััะธัะพะฒะฐะฝะธะต

### ะัะพััะพะน ัะตัั ััััะบัััั:

```python
from logic.valence import SporeValence

valence = SporeValence(spore_id="test")

# ะัะพะฒะตัะบะฐ ะดะตัะตะน
assert len(valence.children_slots) == 4
assert valence.children_slots[0].get_slot_name() == 'forward_max'
assert valence.children_slots[1].get_slot_name() == 'forward_min'
assert valence.children_slots[2].get_slot_name() == 'backward_max'
assert valence.children_slots[3].get_slot_name() == 'backward_min'

# ะัะพะฒะตัะบะฐ ะฒะฝัะบะพะฒ
assert len(valence.grandchildren_slots) == 8
slot_names = [s.get_slot_name() for s in valence.grandchildren_slots]
assert 'forward_max_forward_min' in slot_names
assert 'forward_max_forward_max' not in slot_names  # ะะตั ะฑะตะท ะฐะปััะตัะฝะฐัะธะธ!
```

---

## ะััะพัะธั ะธัะฟัะฐะฒะปะตะฝะธะน

### v2.0 - ะขะตะบััะฐั ะฒะตััะธั (2025-10-17) โ

**ะัะฟัะฐะฒะปะตะฝะฝัะต ัะฐะนะปั:**
- `valence.py` - ััััะบัััะฐ ัะปะพัะพะฒ
- `valence_manager.py` - ะปะพะณะธะบะฐ ะฐะฝะฐะปะธะทะฐ

**ะัะต ะธัะฟัะฐะฒะปะตะฝะธั:**

1. **ะฃะฟัะฐะฒะปะตะฝะธะต ะดะปั ะฒัะพะดััะธั ัะฒัะทะตะน**
   - โ ะัะปะพ: `control_value = -raw_control` (ะธะฝะฒะตััะธัะพะฒะฐะปะพัั)
   - โ ะกัะฐะปะพ: `control_value = raw_control` (ะะ ะธะฝะฒะตััะธััะตััั)
   - **ะัะธัะธะฝะฐ:** ะฃะฟัะฐะฒะปะตะฝะธะต ะพะฟัะตะดะตะปัะตั ััะฐะตะบัะพัะธั, ะฝะต ะฝะฐะฟัะฐะฒะปะตะฝะธะต ะดะฒะธะถะตะฝะธั

2. **ะะพััะดะพะบ ัะปะพัะพะฒ ะดะตัะตะน**
   - โ ะัะปะพ: `forward_max, backward_min, forward_min, backward_max`
   - โ ะกัะฐะปะพ: `forward_max, forward_min, backward_max, backward_min`

3. **ะะพะปะธัะตััะฒะพ ัะปะพัะพะฒ ะฒะฝัะบะพะฒ**
   - โ ะัะปะพ: 4 ัะปะพัะฐ (ะฒัะต ะผะฐัััััั)
   - โ ะกัะฐะปะพ: 8 ัะปะพัะพะฒ (ัะพะปัะบะพ ั ะฐะปััะตัะฝะฐัะธะตะน ัะฟัะฐะฒะปะตะฝะธั)
   - **ะคะธะปััั:** `if first_control_type == second_control_type: continue`

4. **ะะฐะณััะทะบะฐ ะธะท JSON**
   - โ ะัะปะพ: `dt_value = None` (link_object ะฝะต ัะพะทะดะฐะฒะฐะปัั)
   - โ ะกัะฐะปะพ: ะงัะตะฝะธะต ะธะท `EdgeInfo` ะฝะฐะฟััะผัั
   - **ะะพะด:**
     ```python
     # ะัะพะฑัะตะผ link_object
     if hasattr(edge_info, 'link_object') and edge_info.link_object:
         return edge_info.link_object.dt_value
     # Fallback: ัะธัะฐะตะผ ะธะท EdgeInfo ะฝะฐะฟััะผัั
     if hasattr(edge_info, 'dt_value'):
         return edge_info.dt_value
     ```

5. **ะฃะดะฐะปะตะฝั ะดัะฑะปะธะบะฐัั**
   - ะฃะดะฐะปะตะฝั ะดัะฑะปะธัะพะฒะฐะฝะฝัะต ััะฝะบัะธะธ `_convert_to_float`, `_determine_time_direction`, `_determine_control_type`

**ะะตะทัะปััะฐัั ัะตััะธัะพะฒะฐะฝะธั:**

ะะพ ะธัะฟัะฐะฒะปะตะฝะธั:
```
backward_max โ 6  โ (ะดะพะปะถะฝะพ ะฑััั 4)
backward_min โ 4  โ (ะดะพะปะถะฝะพ ะฑััั 6)
```

ะะพัะปะต ะธัะฟัะฐะฒะปะตะฝะธั:
```
forward_max โ 3   โ
forward_min โ 5   โ
backward_max โ 4  โ
backward_min โ 6  โ
ะะฝัะบะพะฒ: 8         โ
```

### v1.0 - ะะตัะฒะฐั ะฒะตััะธั (ะพัะธะฑะพัะฝะฐั) โ

**ะัะพะฑะปะตะผั:**
1. ะฃะฟัะฐะฒะปะตะฝะธะต ะธะฝะฒะตััะธัะพะฒะฐะปะพัั ะดะปั ะฒัะพะดััะธั ัะฒัะทะตะน
2. ะะตะฟัะฐะฒะธะปัะฝัะน ะฟะพััะดะพะบ ัะปะพัะพะฒ ะดะตัะตะน
3. ะขะพะปัะบะพ 4 ัะปะพัะฐ ะฒะฝัะบะพะฒ ะฒะผะตััะพ 8
4. ะะต ัะฐะฑะพัะฐะปะฐ ะทะฐะณััะทะบะฐ ะธะท JSON

**ะัะธัะธะฝะฐ ะพัะธะฑะบะธ:** ะะตะฟัะฐะฒะธะปัะฝะพะต ะฟะพะฝะธะผะฐะฝะธะต ัะธะทะธัะตัะบะพะณะพ ัะผััะปะฐ. ะัะผะฐะปะธ ััะพ ัะฟัะฐะฒะปะตะฝะธะต ะผะตะฝัะตััั ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ ะฝะฐะฟัะฐะฒะปะตะฝะธั ะดะฒะธะถะตะฝะธั.

---

## ะะฐะบะปััะตะฝะธะต

ะกะธััะตะผะฐ ะฒะฐะปะตะฝัะฝะพััะธ ะฟะพะทะฒะพะปัะตั:

1. **ะััะปะตะถะธะฒะฐัั** ะทะฐะฝัััะต ะธ ัะฒะพะฑะพะดะฝัะต ะฒะฐะปะตะฝัะฝัะต ะผะตััะฐ ะบะฐะถะดะพะน ัะฟะพัั
2. **ะะปะฐะฝะธัะพะฒะฐัั** ัะพัั ะดะตัะตะฒะฐ (ะบะฐะบะธะต ัะปะพัั ัะฒะพะฑะพะดะฝั ะดะปั ะฝะพะฒัั ัะฟะพั)
3. **ะะฟัะธะผะธะทะธัะพะฒะฐัั** dt ะทะฝะฐัะตะฝะธั, ัะพััะฐะฝัั ัััะตััะฒัััะธะต ัะฒัะทะธ
4. **ะะธะทัะฐะปะธะทะธัะพะฒะฐัั** ััััะบัััั ัะพัะตะดััะฒะฐ ะฒ ะฟะพะฝััะฝะพะผ ะฒะธะดะต

**ะะปััะตะฒะพะน ะฟัะธะฝัะธะฟ:** ะฃะฟัะฐะฒะปะตะฝะธะต ะพะฟัะตะดะตะปัะตั **ััะฐะตะบัะพัะธั**, ะฒัะตะผั ะพะฟัะตะดะตะปัะตั **ะฝะฐะฟัะฐะฒะปะตะฝะธะต ะดะฒะธะถะตะฝะธั** ะฟะพ ะฝะตะน.

### ะััััะฐั ัะฟัะฐะฒะบะฐ

```python
# ะะฝะฐะปะธะท ะฒะฐะปะตะฝัะฝะพััะธ
valence = manager.analyze_spore_valence(spore_id)
valence.print_summary()

# ะะพะปััะธัั ะทะฐะฝัััะต/ัะฒะพะฑะพะดะฝัะต ัะปะพัั
occupied = valence.get_occupied_slots()  # ะกััะตััะฒัััะธะต ัะฒัะทะธ
free = valence.get_free_slots()          # ะัะดะฐ ะผะพะถะฝะพ ัะฐััะธ

# ะะปั ะพะฟัะธะผะธะทะฐัะพัะฐ
fixed_dt = valence.get_fixed_dt_values()      # ะะต ััะพะณะฐัั
free_slots = valence.get_free_slot_names()    # ะัะถะฝะพ ะทะฐะฟะพะปะฝะธัั
```

---

*ะะพะบัะผะตะฝัะฐัะธั ัะพะทะดะฐะฝะฐ: 2025-10-17*
*ะะตััะธั: 2.0*
*ะะฒัะพั: ValenceManager Team*
*ะกัะฐััั: โ ะะกะ ะะะะะะะะซ ะะกะะะะะะะะซ*
